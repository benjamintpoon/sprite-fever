<!-- canvas.html -->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Canvas Test</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/foundation.min.css">
</head>
<style>
	body {
		background-color: #444;
	}
	.container {
		padding: 30px;
		margin: 0 auto;
		width: 1140px;
	}
	.grid-container {
		position: relative;
		clear: both;
	}
	canvas {
		cursor: crosshair;
	}
	#bg, #overlay {
		position: absolute;
		left: 0;
		top: 0;
	}
	#bg {
		border: 1px dotted #000;
		z-index: 0;
	}
	#overlay {
		border: 1px solid #fff;
		z-index: 999;
		opacity: 0;
	}
	#color-picker {
		float: right;
		border: 1px solid #ccc;
		padding: 10px;
		width: 100%;
	}
	#controls {
		float: right;
	}
	#color-map {
		background-image: url('map-saturation.png');
		height: 255px;
		width: 270px;
	}
	#swatch-container {
		margin: 0;
		font-size: 0; /*hack to remove space between swatches*/
	}
	.swatch {
		display: inline-block;
		height: 30px;
		width: 30px;
		background-color: #000;
	}
</style>
<body>
	<div class="container">
		<div class="row"> <!-- main row -->

			<div id="left" class="columns large-3">
				<div class="row">
					<div id="color-picker">
						<canvas id="color-picker-canvas"></canvas>
						<div id="swatch-container">
							<div class="swatch swatch-0"></div>
							<div class="swatch swatch-1"></div>
							<div class="swatch swatch-2"></div>
							<div class="swatch swatch-3"></div>
							<div class="swatch swatch-4"></div>
							<div class="swatch swatch-5"></div>
							<div class="swatch swatch-6"></div>
							<div class="swatch swatch-7"></div>
							<div class="swatch swatch-8"></div>
						</div>
					</div>
				</div>
				<div class="row">
					<div id="toolbar">
						<button id="button-clear" class="button clear">clear</button>
					</div>
				</div>
			</div>

			<div id="middle" class="columns large-5">
				<div class="grid-container">
					<canvas id="overlay"></canvas>		
					<canvas id="bg"></canvas>
				</div>
			</div>

			<div id="right"class="columns large-3">
				<div id="controls">
					<button id="button-save" class="button save">Save</button>
				</div>
			</div>
		</div> <!-- end main container row -->
	</div>
	<script type="text/javascript" src="jquery-1.11.1.min.js"></script>
	<script type="text/javascript">

		// Constants(for now)
		// adjust this stuff..
		// with form controls later?
		const TILE_SIZE = 30;
		const GRID_X = 16;
		const GRID_Y = 20;
		const NUM_SWATCHES = 9;
		const SWATCH_LIGHTNESS_STEP = Math.ceil(255 / NUM_SWATCHES); //29 for 9 swatches;
		const LIGHT_GREY  = 'rgba(200, 200, 200, 1)';
		const WHITE = 'rgba(255, 255, 255, 1)';
		const GRID_BG_COLORS = [LIGHT_GREY, WHITE];

		// Editor Canvases
		var overlay = document.getElementById("overlay");
		var bg      = document.getElementById("bg");
		var bgCTX   = bg.getContext("2d");
		bg.width    = overlay.width  = TILE_SIZE * GRID_X;
		bg.height   = overlay.height = TILE_SIZE * GRID_Y;
		
		// Color Picker & Swatches
		var picker    = document.getElementById("color-picker-canvas");
		var pickerCTX = picker.getContext("2d");
		var swatches  = document.querySelectorAll('.swatch');
		var swatchParent = document.querySelector('.swatch').parentNode;

		// resize picker & swatches
		picker.width  = $(picker.parentNode).width();
		picker.height = 255;
		$('.swatch').width($(swatchParent).width() / swatches.length);
		var colorMap = new Image();
		colorMap.onload = function() {
			pickerCTX.drawImage(colorMap, 0, 0, picker.width, picker.height);
		};
		colorMap.crossOrigin = "anonymous"; // CORS bullshit
		colorMap.src = "http://localhost:8000/map-saturation.png"; // CORS bullshit
		var colorPickerData = pickerCTX.getImageData(0, 0, picker.width, picker.height);

		// Color Variables
		var selectedColor = 'rgba(0,0,0,1)';
		var colorCounter = 0;

		// Why would I ever have multiple grids..?
		function Grid(el, width, height) {
			this.el = el;
			this.width = width;
			this.height = height;
			this.tiles = {};
		}

		Grid.prototype.initialize = function(render) {
			for (var r = 0; r < this.height; r++) {
				this.tiles[r] = {};
				for (var c = 0; c < this.width; c++) { 
					var t = new Tile(c, r, GRID_BG_COLORS[(c + r) % 2]);
					this.tiles[r][c] = t;
					if (render) t.render(t.color);
				}
			}
		}

		Grid.prototype.save = function() {

		}

		function Tile(x, y, color) {
			this.x = x;
			this.y = y;
			this.color = color;
			this.empty = true;
		}

		Tile.prototype.render = function(color) {
			var color = color || this.color;
			bgCTX.fillStyle = color;
			bgCTX.fillRect(
				this.x * TILE_SIZE, 
				this.y * TILE_SIZE, 
				TILE_SIZE, 
				TILE_SIZE);
		}; 	


		$(function(){

			var bgGrid = new Grid(bg, GRID_X, GRID_Y);
			var oGrid  = new Grid(overlay, GRID_X, GRID_Y);

			bgGrid.initialize(true);
			oGrid.initialize();

			var $bg      = $(bg);
			var $overlay = $(overlay);

			$overlay.on('mousedown', function(e) {
				e.preventDefault();

				var gridX = Math.floor((e.offsetX - 1)/ TILE_SIZE);
				var gridY = Math.floor((e.offsetY - 1)/ TILE_SIZE);

				var tile = oGrid.tiles[gridY][gridX];
				tile.color = selectedColor;
				tile.empty = false;
				tile.render();

				$(this).on('mouseout', function(e) { 
					$(this).unbind('mousemove');
				});

				$(this).on('mouseup', function(e) {
					$(this).unbind('mousemove');
				});

				$(this).on('mousemove', function(e) {
					e.preventDefault();

					var lastX = gridX;
					var lastY = gridY;

					var gridX = Math.floor((e.offsetX - 1)/ TILE_SIZE);
					var gridY = Math.floor((e.offsetY - 1)/ TILE_SIZE);

					if (gridX !== lastX || gridY !== lastY) {
						var tile = oGrid.tiles[gridY][gridX];
						tile.fillColor = selectedColor;
						tile.render(tile.fillColor);
					}
				}); // end mousedown

				$('.swatch').on('click', function(e) {
					selectedColor = $(this).css('background-color');
				}); 

			});

			$(picker).on('click', function(e) {
				selectedColor = getPixelColor(e.offsetX, e.offsetY);
				updateSwatches();
			});

		function getPixelColor(x, y) {
			var rgba = pickerCTX.getImageData(x, y, 1, 1).data;
			return "rgba("+rgba[0]+","+rgba[1]+","+rgba[2]+","+rgba[3]+")";
		}

		// this doesn't actually, really lighten stuff?
		// but it does some cool/strange stuff
		function rgbaLighten(str, mult) {
			// parse an 'rgba(r,g,b,a)' string
			// return an array of integers as strings;
			str = str.substring(5, str.length-1).split(',');
			// find the 0 color value and update;
			str[str.indexOf('0')] = mult * SWATCH_LIGHTNESS_STEP;
			// rebuild the rgba string
			// console.log(str);
			// console.log("rgba(" + str.join(',') + ")");
			return "rgba(" + str.join(',') + ")";
		}

		function updateSwatches() {
			// loop over numSwatches
			// concat class string
			// calculate the rgba code
			// update swatch bgcolor
				// find which rgb value is zero
				// increment by 255/9?
			var klass = ".swatch-";
			for (var i = 0; i < NUM_SWATCHES; i++) {
				var $swatch = $(klass + i);
				var newColor = rgbaLighten(selectedColor, i);
				$swatch.css('background-color', newColor);
			}
		}
	});
	</script>
</body>
</html>
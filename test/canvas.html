<!-- canvas.html -->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Canvas Test</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/foundation.css">
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="container">
		<div class="row"> <!-- main row -->
			<div id="left" class="columns large-3">
				<div class="row">
					<div id="color-picker">
						<canvas id="color-picker-canvas"></canvas>
						<div id="swatch-container">
							<div class="swatch swatch-0"></div>
							<div class="swatch swatch-1"></div>
							<div class="swatch swatch-2"></div>
							<div class="swatch swatch-3"></div>
							<div class="swatch swatch-4"></div>
							<div class="swatch swatch-5"></div>
							<div class="swatch swatch-6"></div>
							<div class="swatch swatch-7"></div>
							<div class="swatch swatch-8"></div>
						</div>
					</div>
				</div>
				<div class="row">
					<div id="toolbar">
						Toolbar
						<button id="button-clear" class="button clear">clear</button>
					</div>
				</div>
			</div>

			<div id="middle" class="columns large-5">
				<div class="grid-container">
					<canvas id="overlay"></canvas>		
					<canvas id="bg"></canvas>
				</div>
			</div>

			<div id="right"class="columns large-3">
				<div class="row">
					<div class="controls">Controls</div>
				</div>
				<div class="row">
					<div class="preview">
						Preview
						<canvas id="preview"></canvas>
					</div>
				</div>
				<div class="row">
					<div class="menu">
						Menu
						<button id="button-save" class="button save">Save</button>
					</div>
				</div>
			</div>
		</div> <!-- end main container row -->
	</div>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/grid.js"></script>
	<script type="text/javascript">

		// Constants(for now)
		// adjust this stuff..
		// with form controls later?
		const TILE_SIZE = 30;
		const GRID_X = 16;
		const GRID_Y = 20;
		const NUM_SWATCHES = 9;
		const SWATCH_LIGHTNESS_STEP = Math.ceil(255 / NUM_SWATCHES); //29 for 9 swatches;
		const LIGHT_GREY  = 'rgba(200, 200, 200, 1)';
		const WHITE = 'rgba(255, 255, 255, 1)';
		const GRID_BG_COLORS = [LIGHT_GREY, WHITE];

		// Editor Canvases
		var overlay = document.getElementById("overlay");
		var preview = document.getElementById("preview");
		var bg      = document.getElementById("bg");
		var bgCTX   = bg.getContext("2d");
		var oCTX    = overlay.getContext("2d");
		var pCTX    = oCTX.translate(overlay.width, overlay.height);
		bg.width    = overlay.width  = TILE_SIZE * GRID_X;
		bg.height   = overlay.height = TILE_SIZE * GRID_Y;

		// Color Picker & Swatches
		var picker    = document.getElementById("color-picker-canvas");
		var pickerCTX = picker.getContext("2d");
		var swatches  = document.querySelectorAll('.swatch');
		var swatchParent = document.querySelector('.swatch').parentNode;

		// resize picker & swatches
		picker.width  = $(picker.parentNode).width();
		picker.height = 255;
		$('.swatch').width($(swatchParent).width() / swatches.length);
		var colorMap = new Image();
		colorMap.onload = function() {
			pickerCTX.drawImage(colorMap, 0, 0, picker.width, picker.height);
		};
		colorMap.crossOrigin = "anonymous"; // CORS bullshit
		colorMap.src = "http://localhost:8000/map-saturation.png"; // CORS bullshit
		var colorPickerData = pickerCTX.getImageData(0, 0, picker.width, picker.height);

		// Color Variables
		var selectedColor = 'rgba(0,0,0,1)';
		var colorCounter = 0;

		$(function(){

			var Grid = MyGrid.grid;
			
			var bgGrid = new Grid(bg, GRID_X, GRID_Y);
			var oGrid  = new Grid(overlay, GRID_X, GRID_Y);
			var pGrid  = new Grid(overlay, GRID_X, GRID_Y);

			bgGrid.initialize(true);
			oGrid.initialize();

			var $bg      = $(bg);
			var $overlay = $(overlay);
			var $preview = $(preview);

			$('#button-clear').on('click', function(e) {
				oGrid.clear();
			});			

			$('#button-save').on('click', function(e) {
				oGrid.save();
			});

			$(picker).on('click', function(e) {
				selectedColor = getPixelColor(e.offsetX, e.offsetY);
				updateSwatches();
			});

			$overlay.on('mousedown', function(e) {
				e.preventDefault();

				var gridX = Math.floor((e.offsetX - 1)/ TILE_SIZE);
				var gridY = Math.floor((e.offsetY - 1)/ TILE_SIZE);

				var tile = oGrid.tiles[gridY][gridX];
				var ptile = oGrid.tiles[gridY][gridX];
				tile.color = ptile.color = selectedColor;
				// tile.empty = false;
				tile.render();
				ptile.render();
				
				$(this).on('mousemove', function(e) {
					e.preventDefault();

					var lastX = gridX;
					var lastY = gridY;

					var gridX = Math.floor((e.offsetX - 1)/ TILE_SIZE);
					var gridY = Math.floor((e.offsetY - 1)/ TILE_SIZE);

					if (gridX !== lastX || gridY !== lastY) {
						var tile = oGrid.tiles[gridY][gridX];
						tile.fillColor = ptile.fillColor = selectedColor;
						tile.render(tile.fillColor);
						ptile.render(ptile.fillColor);
					}

					$(this).on('mouseout', function(e) { 
						$(this).off('mousemove');
					});

					$(this).on('mouseup', function(e) {
						$(this).unbind('mousemove');
					});

				}); // end mousedown

				$('.swatch').on('click', function(e) {
					selectedColor = $(this).css('background-color');
				}); 

			}); // end $overlay handlers

		function getPixelColor(x, y) {
			var rgba = pickerCTX.getImageData(x, y, 1, 1).data;
			return "rgba("+rgba[0]+","+rgba[1]+","+rgba[2]+","+rgba[3]+")";
		}

		// this doesn't actually, really lighten stuff?
		// but it does some cool/strange stuff
		function rgbaLighten(str, mult) {
			// parse an 'rgba(r,g,b,a)' string
			// return an array of integers as strings;
			str = str.substring(5, str.length-1).split(',');
			// find the 0 color value and update;
			str[str.indexOf('0')] = mult * SWATCH_LIGHTNESS_STEP;
			// rebuild the rgba string
			// console.log(str);
			// console.log("rgba(" + str.join(',') + ")");
			return "rgba(" + str.join(',') + ")";
		}

		function updateSwatches() {
			// loop over numSwatches
			// concat class string
			// calculate the rgba code
			// update swatch bgcolor
				// find which rgb value is zero
				// increment by 255/9?
			var klass = ".swatch-";
			for (var i = 0; i < NUM_SWATCHES; i++) {
				var $swatch = $(klass + i);
				var newColor = rgbaLighten(selectedColor, i);
				$swatch.css('background-color', newColor);
			}
		}
	});
	</script>
</body>
</html>